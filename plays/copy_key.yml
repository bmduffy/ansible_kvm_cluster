---

- name: "Wait for ssh port on '{{ hostname }}'"
  wait_for:
    port: 22
    host: "{{ hostname }}"

- name: "Check if passwordless ssh is possible"
  shell: |
    ssh {{ user }}@{{ hostname }} \
      -o StrictHostKeyChecking=no \
      -o PasswordAuthentication=no /bin/bash
  register: auth

  failed_when: auth.rc not in (0, 255)
- name: "Copy '{{ public_key | basename }}' to '{{ hostname }}'"
  shell: |
    sshpass -p {{ password }} \
    ssh-copy-id -o StrictHostKeyChecking=no \
                -o IdentitiesOnly=yes \
                -i {{ public_key }} {{ user }}@{{ hostname }}
  when: auth.rc != 0
