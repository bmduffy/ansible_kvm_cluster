---

# Setting up NFS, important files
# >> /etc/exports       - main config file for NFS, all exported files and dirs deinfed here
# >> /etc/fstab         - mount a directory on system across reboots
# >> /etc/sysconfig/nfs - daemon ctrl, RPC ports, svc listen

- name: "Configure NFS clients on all nodes"
  hosts: all
  vars:
      pkgs:
          - "nfs-utils"
          - "nfs-utils-lib"
      sels:
          - "virt_use_nfs"
          - "virt_sandbox_use_nfs"
  tasks:
      - name: "Install NFS packages"
        yum:
            name: "{{ item }}"
            state: present
        with_items: "{{ pkgs }}"
      - name:  "Start NFS clients"
        systemd:
            name: nfs
            state: started
      - name: "Enable services"
        systemd:
            name: nfs
            enabled: yes
      - name: "Default NFS SELinux policies do not allow containers to access NFS shares"
        seboolean:
            name: "{{ item }}"
            state: yes
            persistent: yes
        with_items: "{{ sels }}"

# Some important commands
#
# >> showmount -e : Shows the available shares on your local machine
# >> showmount -e <server-ip or hostname>: Lists the available shares at the remote server
# >> showmount -d : Lists all the sub directories
# >> exportfs -v : Displays a list of shares files and options on a server
# >> exportfs -a : Exports all shares listed in /etc/exports, or given name
# >> exportfs -u : Unexports all shares listed in /etc/exports, or given name
# >> exportfs -r : Refresh the serverâ€™s list after modifying /etc/exports

- name: "Configure NFS server on the load balancer"
  hosts: lb1
  tasks:
      - name: "Create an NFS share directory with setuid and setgid"
        file:
            path: "/nfs_share"
            owner: nfsnobody
            group: nfsnobody
            mode: 0700
            state: directory
      - name: "Open NFS ports"
        iptables:
            action: insert
            chain: INPUT
            protocol: "{{ item }}"
            destination_port: 2049
            jump: ACCEPT
        with_items: ["tcp", "udp"]
      - name: "Ensure the NFS server is started"
        systemd:
            name: nfs-server
            state: started
      - name: "Ensure the NFS server is enabled"
        systemd:
            name: nfs-server
            enabled: yes

- name: "Create a password file on the load balancer"
  hosts: lb1
  vars:
      htpasswd: "/nfs_share/htpasswd"
  tasks:
      - name: "Install HTPasswd tools"
        yum:
            name: httpd-tools
            state: present
      - name: "Create HTPasswd directory"
        file:
            path: "{{ htpasswd }}"
            owner: nfsnobody
            group: nfsnobody
            mode: 0700
            state: directory
      - name: "Export the directory"
        lineinfile:
            path: "/etc/exports"
            regexp: "^{{ htpasswd }}"
            line: "{{ htpasswd }} {{ inventory_hostname }} (rw,sync,no_root_squash)"
      - name: "Export all NFS share directories"
        command: /usr/sbin/exportfs -a
      - name: "Create a password file"
        file:
            path: "{{ htpasswd }}/passwords"
            state: touch

- name: "Configure cluster to use HTPasswd"
  hosts: masters
  vars:
      password_dir: "/etc/origin/master/htpasswd"
      password_file: "{{ password_dir }}/passwords"
      mount_src: "lb01.shifters.com:/nfs_share/htpasswd"
  tasks:
      - name: "Ensure that relevant packages are installed"
        yum:
            name: "httpd-tools"
            state: present
      - name: "Ensure password directory is present"
        file:
            path: "{{ password_dir }}"
            state: directory
        # noticed that the mount module automatically adds an entry in /etc/fstab
      - name: "Mount htpasswd directory so all masters have access"
        mount:
            fstype: nfs
            path: "{{ password_dir }}"
            src: "{{ mount_src }}"
            state: mounted
